#include <Wire.h>
#include <LiquidCrystal_I2C.h>

#define SENSOR_FLUJO_PIN 4     // Sensor de flujo YF-S201

LiquidCrystal_I2C lcd(0x27, 16, 2);

// Variables del sensor de flujo
volatile uint32_t pulsos = 0;
float litros = 0.0;
unsigned long t_anterior = 0;

// ----------------------+
// INTERRUPCIÓN DEL SENSOR
// ----------------------+
void IRAM_ATTR contar_pulso() {
  pulsos++;
}

void setup() {
  Serial.begin(115200);

  // LCD
  lcd.init();
  lcd.backlight();
  lcd.clear();
  lcd.print("Inicializando...");
  delay(1500);

  // Sensor de flujo
  pinMode(SENSOR_FLUJO_PIN, INPUT_PULLUP);
  attachInterrupt(digitalPinToInterrupt(SENSOR_FLUJO_PIN), contar_pulso, RISING);

lcd.clear();
}

void loop() {

  // ----------------------------+
  // CÁLCULO DE FLUJO Y LITROS
  // ----------------------------+
  if (millis() - t_anterior >= 1000) {  // Cada 1 segundo
    noInterrupts();
    uint32_t pulsos_medidos = pulsos;
    pulsos = 0;
    interrupts();

    // Fórmula del YF-S201 (aprox) → 7.5 Hz por L/min
    float caudal_Lmin = pulsos_medidos / 7.5;

    // Litros en 1 segundo (L/min / 60)
    float litros_seg = caudal_Lmin / 60.0;

    litros += litros_seg;

    // ----------------------------+
    // MOSTRAR EN LCD
    // ----------------------------+
    lcd.clear();
    lcd.setCursor(0, 0);
    lcd.print("Flujo:");
    lcd.print(caudal_Lmin, 1);
    lcd.print(" L/m");

    lcd.setCursor(0, 1);
    lcd.print("Litros:");
    lcd.print(litros, 2);

    t_anterior = millis();
  }
